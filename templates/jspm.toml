[[template]]
name = "jspm"
definition = """({ name, targets, deps, env, options: {
  env: generatorEnv = ['browser', 'production', 'module'],
  preload,
  integrity,
  whitespace,
  esModuleShims,
  ...generateOpts
} }) => [{
  name,
  targets,
  deps: [...deps, 'node_modules/@jspm/generator', 'node_modules/mkdirp'],
  env,
  engine: 'node',
  run: `
    import { Generator } from '@jspm/generator';
    import { readFile, writeFile } from 'fs/promises';
    import { pathToFileURL } from 'url';
    import mkdirp from 'mkdirp';
    import { dirname, relative, resolve } from 'path';

    const opts = ${JSON.stringify(generateOpts)};
    const htmlUrl = pathToFileURL(process.env.TARGET);

    if (opts.resolutions) {
      const newResolutions = {};
      // renormalize relative resolutions relative to cwd
      const cwd = process.cwd();
      for (const key of Object.keys(opts.resolutions)) {
        const target = opts.resolutions[key];
        if (!target.startsWith('./') && !target.startsWith('../')) {
          newResolutions[key] = target;
          continue;
        }
        const normalizedTarget = relative(dirname(resolve(cwd, process.env.TARGET)), resolve(cwd, target)).replace(/\\\\\\\\/g, '/');
        newResolutions[key] = normalizedTarget;
      }
      opts.resolutions = newResolutions;
    }

    const generator = new Generator({
      mapUrl: htmlUrl,
      env: ${JSON.stringify(generatorEnv)},
      ...opts
    });

    const htmlSource = await readFile(process.env.DEP, 'utf-8');
    const htmlOpts = ${JSON.stringify({ preload, integrity, whitespace, esModuleShims })};
    htmlOpts.htmlUrl = htmlUrl;
    const outHtml = await generator.htmlGenerate(htmlSource, htmlOpts);

    mkdirp.sync(dirname(process.env.TARGET));
    await writeFile(process.env.TARGET, outHtml);
  `
}, {
  template: 'npm',
  options: {
    packages: ['@jspm/generator', 'mkdirp'],
    dev: true
  }
}]
"""
